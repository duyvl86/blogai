<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NongTech CMS - Qu·∫£n l√Ω b√†i vi·∫øt</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { color: #333; }
    h2 { color: #333; margin-top: 0; }
    .btn { background: #0969da; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; font-size: 14px; }
    .btn:hover { background: #0856b8; }
    .btn-secondary { background: #6e7781; }
    .btn-secondary:hover { background: #5d6a77; }
    .btn-danger { background: #cf222e; }
    .btn-danger:hover { background: #b52a30; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .post { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .post h2 { margin: 0 0 10px; font-size: 18px; }
    .post-meta { color: #666; font-size: 13px; margin-bottom: 10px; }
    .post-meta span { margin-right: 15px; }
    .tags { margin-top: 8px; }
    .tag { background: #e8f4fd; color: #0969da; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
    .actions { margin-top: 15px; }
    .logout { float: right; color: #666; text-decoration: none; }
    .editor { display: none; }
    .editor.active { display: block; }
    textarea { width: 100%; height: 400px; font-family: monospace; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
    input[type="text"], input[type="datetime-local"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .form-row { display: flex; gap: 15px; }
    .form-row .form-group { flex: 1; }
    .error { color: red; padding: 10px; background: #ffe6e6; border-radius: 6px; margin-bottom: 20px; }
    .success { color: green; padding: 10px; background: #e6f4ea; border-radius: 6px; margin-bottom: 20px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .info-box { background: #e8f4fd; border: 1px solid #0969da; border-radius: 6px; padding: 15px; margin-bottom: 20px; }
    .help-text { color: #666; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="/admin/" class="logout" onclick="logout()">ƒêƒÉng xu·∫•t</a>
    <h1>NongTech CMS</h1>
    <div id="app">
      <div class="loading">ƒêang t·∫£i...</div>
    </div>
  </div>

  <script>
    const REPO = 'duyvl86/blogai';
    const BRANCH = 'main';
    const API_BASE = 'https://api.github.com';
    
    let token = localStorage.getItem('github_token');
    let posts = [];
    let currentFile = null;
    let categories = ['AI', 'Machine Learning', 'Cloud Computing', 'Programming', 'Agriculture Tech'];
    let tags = ['AI', 'Machine Learning', 'Python', 'Cloud', 'Tutorial', 'Beginner', 'Advanced', 'News'];
    
    if (!token) {
      window.location.href = '/admin/';
    }
    
    const headers = {
      'Authorization': 'token ' + token,
      'Accept': 'application/vnd.github.v3+json'
    };
    
    async function apiCall(url, options = {}) {
      const response = await fetch(API_BASE + url, {
        ...options,
        headers: { ...headers, ...options.headers }
      });
      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.message || 'API Error');
      }
      return response.json();
    }
    
    async function loadPosts() {
      try {
        const files = await apiCall(`/repos/${REPO}/contents/src/content/blog?ref=${BRANCH}`);
        posts = files.filter(f => f.name.endsWith('.md') || f.name.endsWith('.mdx'));
        
        for (let post of posts) {
          try {
            const content = await apiCall(`/repos/${REPO}/contents/${post.path}?ref=${BRANCH}`);
            const decoded = decodeURIComponent(escape(atob(content.content)));
            post.fullContent = decoded;
            const match = decoded.match(/^---\n([\s\S]*?)\n---/);
            if (match) {
              const fm = match[1];
              post.title = fm.match(/title:\s*["']?(.*?)["']?\s*$/m)?.[1] || post.name;
              post.description = fm.match(/description:\s*["']?(.*?)["']?\s*$/m)?.[1] || '';
              post.date = fm.match(/date:\s*(.*?)\s*$/m)?.[1] || '';
              post.category = fm.match(/category:\s*["']?(.*?)["']?\s*$/m)?.[1] || 'ai';
              post.tags = fm.match(/tags:\s*\[(.*?)\]/m)?.[1]?.split(',').map(t => t.trim().replace(/["']/g, '')) || [];
              post.image = fm.match(/image:\s*["']?(.*?)["']?\s*$/m)?.[1] || '';
              post.author = fm.match(/author:\s*["']?(.*?)["']?\s*$/m)?.[1] || 'Admin';
              post.featured = fm.match(/featured:\s*(.*?)\s*$/m)?.[1]?.trim() === 'true';
            }
          } catch (e) {
            post.title = post.name.replace('.md', '').replace('.mdx', '');
          }
        }
        
        renderPostList();
      } catch (e) {
        document.getElementById('app').innerHTML = `<div class="error">L·ªói: ${e.message}</div>`;
      }
    }
    
    function renderPostList() {
      let html = `
        <div class="info-box">
          <strong>L∆∞u √Ω:</strong> Sau khi t·∫°o/s·ª≠a b√†i vi·∫øt, GitHub Actions s·∫Ω t·ª± ƒë·ªông deploy trong v√†i ph√∫t.
        </div>
        <div style="margin-bottom: 20px;">
          <button class="btn" onclick="showNewPost()">+ B√†i vi·∫øt m·ªõi</button>
          <button class="btn btn-secondary" onclick="loadPosts()">üîÑ T·∫£i l·∫°i</button>
        </div>
      `;
      
      if (posts.length === 0) {
        html += '<p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o. Click "+ B√†i vi·∫øt m·ªõi" ƒë·ªÉ t·∫°o.</p>';
      }
      
      for (const post of posts) {
        const title = post.title || post.name.replace('.md', '').replace('.mdx', '').replace(/-/g, ' ');
        const date = post.date ? new Date(post.date).toLocaleDateString('vi-VN') : 'Ch∆∞a c√≥ ng√†y';
        
        html += `
          <div class="post">
            <h2>${title}</h2>
            <div class="post-meta">
              <span>üìÖ ${date}</span>
              <span>üìÅ ${post.category || 'Ch∆∞a ph√¢n lo·∫°i'}</span>
              <span>‚úçÔ∏è ${post.author || 'Admin'}</span>
            </div>
            <p>${post.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
            <div class="tags">
              ${(post.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
            <div class="actions">
              <button class="btn btn-sm" onclick="editPost('${post.path}')">‚úèÔ∏è S·ª≠a</button>
              <button class="btn btn-sm btn-danger" onclick="deletePost('${post.path}')">üóëÔ∏è X√≥a</button>
            </div>
          </div>
        `;
      }
      
      document.getElementById('app').innerHTML = html;
    }
    
    function showNewPost() {
      const title = prompt('Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt:');
      if (!title) return;
      
      const slug = title.toLowerCase().replace(/[^a-z0-9\u00c0-\u024f]+/g, '-').replace(/^-|-$/g, '');
      const date = new Date().toISOString().split('T')[0];
      
      document.getElementById('app').innerHTML = `
        <div class="editor active">
          <h2>T·∫°o b√†i vi·∫øt m·ªõi</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label>Ti√™u ƒë·ªÅ:</label>
              <input type="text" id="title" value="${title}">
            </div>
            <div class="form-group">
              <label>Slug (URL):</label>
              <input type="text" id="slug" value="${slug}">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Ng√†y ƒëƒÉng:</label>
              <input type="datetime-local" id="date" value="${date}T12:00">
            </div>
            <div class="form-group">
              <label>T√°c gi·∫£:</label>
              <input type="text" id="author" value="Admin">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Danh m·ª•c:</label>
              <select id="category">
                ${categories.map(c => `<option value="${c.toLowerCase()}">${c}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Tags (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y):</label>
              <input type="text" id="tags" placeholder="AI, Machine Learning, Python...">
            </div>
          </div>
          
          <div class="form-group">
            <label>M√¥ t·∫£ ng·∫Øn:</label>
            <input type="text" id="description" placeholder="M√¥ t·∫£ ng·∫Øn v·ªÅ b√†i vi·∫øt...">
          </div>
          
          <div class="form-group">
            <label>·∫¢nh ƒë·∫°i di·ªán (URL):</label>
            <input type="text" id="image" placeholder="/images/blog-placeholder.jpg">
          </div>
          
          <div class="form-group">
            <label>N·ªôi dung (Markdown):</label>
            <textarea id="content" placeholder="Nh·∫≠p n·ªôi dung b√†i vi·∫øt b·∫±ng Markdown..."># ${title}

## Gi·ªõi thi·ªáu

Vi·∫øt n·ªôi dung gi·ªõi thi·ªáu t·∫°i ƒë√¢y...

## N·ªôi dung ch√≠nh

Vi·∫øt n·ªôi dung ch√≠nh t·∫°i ƒë√¢y...

## K·∫øt lu·∫≠n

Vi·∫øt k·∫øt lu·∫≠n t·∫°i ƒë√¢y...
</textarea>
          </div>
          
          <button class="btn" onclick="createPost()">‚úÖ T·∫°o b√†i vi·∫øt</button>
          <button class="btn btn-secondary" onclick="loadPosts()">‚ùå H·ªßy</button>
        </div>
      `;
    }
    
    async function createPost() {
      const title = document.getElementById('title').value;
      const slug = document.getElementById('slug').value;
      const date = document.getElementById('date').value.replace('T', ' ');
      const author = document.getElementById('author').value;
      const category = document.getElementById('category').value;
      const tags = document.getElementById('tags').value;
      const description = document.getElementById('description').value;
      const image = document.getElementById('image').value || '/images/blog-placeholder.jpg';
      const content = document.getElementById('content').value;
      
      const frontmatter = `---
title: "${title}"
description: "${description}"
date: ${date}
author: "${author}"
image: "${image}"
category: "${category}"
tags: [${tags.split(',').map(t => '"' + t.trim() + '"').join(', ')}]
featured: false
---

${content}`;
      
      try {
        await apiCall(`/repos/${REPO}/contents/src/content/blog/${slug}.md`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Create new post: ${slug}`,
            content: btoa(unescape(encodeURIComponent(frontmatter))),
            branch: BRANCH
          })
        });
        alert('‚úÖ T·∫°o b√†i vi·∫øt th√†nh c√¥ng! Deploy s·∫Ω t·ª± ƒë·ªông ch·∫°y trong v√†i ph√∫t.');
        loadPosts();
      } catch (e) {
        alert('‚ùå L·ªói: ' + e.message);
      }
    }
    
    async function editPost(path) {
      try {
        const file = await apiCall(`/repos/${REPO}/contents/${path}?ref=${BRANCH}`);
        const content = decodeURIComponent(escape(atob(file.content)));
        
        const match = content.match(/^---\n([\s\S]*?)\n---/);
        let frontmatter = {};
        let bodyContent = content;
        
        if (match) {
          const fm = match[1];
          bodyContent = content.substring(match[0].length).trim();
          
          frontmatter.title = fm.match(/title:\s*["']?(.*?)["']?\s*$/m)?.[1] || '';
          frontmatter.description = fm.match(/description:\s*["']?(.*?)["']?\s*$/m)?.[1] || '';
          frontmatter.date = fm.match(/date:\s*(.*?)\s*$/m)?.[1] || '';
          frontmatter.author = fm.match(/author:\s*["']?(.*?)["']?\s*$/m)?.[1] || 'Admin';
          frontmatter.category = fm.match(/category:\s*["']?(.*?)["']?\s*$/m)?.[1] || 'ai';
          frontmatter.tags = fm.match(/tags:\s*\[(.*?)\]/m)?.[1]?.split(',').map(t => t.trim().replace(/["']/g, '')).join(', ') || '';
          frontmatter.image = fm.match(/image:\s*["']?(.*?)["']?\s*$/m)?.[1] || '';
          frontmatter.featured = fm.match(/featured:\s*(.*?)\s*$/m)?.[1]?.trim() === 'true';
        }
        
        currentFile = { path, sha: file.sha };
        
        document.getElementById('app').innerHTML = `
          <div class="editor active">
            <h2>S·ª≠a b√†i vi·∫øt</h2>
            
            <div class="form-row">
              <div class="form-group">
                <label>Ti√™u ƒë·ªÅ:</label>
                <input type="text" id="title" value="${frontmatter.title}">
              </div>
              <div class="form-group">
                <label>Danh m·ª•c:</label>
                <select id="category">
                  ${categories.map(c => `<option value="${c.toLowerCase()}" ${c.toLowerCase() === frontmatter.category ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Ng√†y ƒëƒÉng:</label>
                <input type="datetime-local" id="date" value="${frontmatter.date?.replace(' ', 'T') || ''}">
              </div>
              <div class="form-group">
                <label>T√°c gi·∫£:</label>
                <input type="text" id="author" value="${frontmatter.author || 'Admin'}">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Tags (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y):</label>
                <input type="text" id="tags" value="${frontmatter.tags || ''}">
              </div>
              <div class="form-group">
                <label>·∫¢nh ƒë·∫°i di·ªán (URL):</label>
                <input type="text" id="image" value="${frontmatter.image || '/images/blog-placeholder.jpg'}">
              </div>
            </div>
            
            <div class="form-group">
              <label>M√¥ t·∫£ ng·∫Øn:</label>
              <input type="text" id="description" value="${frontmatter.description || ''}">
            </div>
            
            <div class="form-group">
              <label>N·ªôi dung (Markdown):</label>
              <textarea id="content">${bodyContent}</textarea>
            </div>
            
            <button class="btn" onclick="savePost()">üíæ L∆∞u b√†i vi·∫øt</button>
            <button class="btn btn-secondary" onclick="loadPosts()">‚ùå H·ªßy</button>
          </div>
        `;
      } catch (e) {
        alert('L·ªói: ' + e.message);
      }
    }
    
    async function savePost() {
      if (!currentFile) return;
      
      const title = document.getElementById('title').value;
      const date = document.getElementById('date').value.replace('T', ' ');
      const author = document.getElementById('author').value;
      const category = document.getElementById('category').value;
      const tags = document.getElementById('tags').value;
      const description = document.getElementById('description').value;
      const image = document.getElementById('image').value || '/images/blog-placeholder.jpg';
      const bodyContent = document.getElementById('content').value;
      
      const frontmatter = `---
title: "${title}"
description: "${description}"
date: ${date}
author: "${author}"
image: "${image}"
category: "${category}"
tags: [${tags.split(',').map(t => '"' + t.trim() + '"').join(', ')}]
featured: false
---

${bodyContent}`;
      
      try {
        await apiCall(`/repos/${REPO}/contents/${currentFile.path}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Update post: ${currentFile.path}`,
            content: btoa(unescape(encodeURIComponent(frontmatter))),
            branch: BRANCH,
            sha: currentFile.sha
          })
        });
        alert('‚úÖ L∆∞u th√†nh c√¥ng! Deploy s·∫Ω t·ª± ƒë·ªông ch·∫°y trong v√†i ph√∫t.');
        loadPosts();
      } catch (e) {
        alert('‚ùå L·ªói: ' + e.message);
      }
    }
    
    async function deletePost(path) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;
      
      try {
        const file = await apiCall(`/repos/${REPO}/contents/${path}?ref=${BRANCH}`);
        
        await apiCall(`/repos/${REPO}/contents/${path}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: `Delete post: ${path}`,
            branch: BRANCH,
            sha: file.sha
          })
        });
        alert('‚úÖ X√≥a th√†nh c√¥ng!');
        loadPosts();
      } catch (e) {
        alert('‚ùå L·ªói: ' + e.message);
      }
    }
    
    function logout() {
      localStorage.removeItem('github_token');
    }
    
    loadPosts();
  </script>
</body>
</html>
